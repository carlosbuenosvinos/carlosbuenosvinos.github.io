---
title: Saved 500 Kbytes of autoload classmap with autoload-dev at @AtrapaloEng
author: Carlos Buenosvinos
type: post
date: 2016-04-14T07:30:15+00:00
url: /saved-500-kbytes-of-autoload-classmap-with-autoload-dev-at-atrapaloeng/
featured_image: /posts/images/2016/04/logo-composer-transparent.png
dsq_thread_id:
  - "4745790389"
categories:
  - PHP
tags:
  - autoload
  - composer
  - performance
  - php

---
This week, at Atrápalo, we have reviewed our autoloading Composer configuration to use PSR-4 and split production classmap from development classmap to save some space in our Opcache. The result, 500 Kbytes less. Let&#8217;s see some details.
  
<!--more-->


  
As you may know, when going to production, it&#8217;s a best practice to run &#8220;php composer.phar dump-autoload &#8211;optimize &#8211;no-dev&#8221; as one of your steps, or just &#8220;php composer.phar install [&#8230;] &#8211;optimize-autoloader &#8211;no-dev&#8221; when installing your dependencies.

With this command, Composer generates a PHP file with a big array where keys are the names of all classes in your project and the values are the path where they can be found. With this approach, autoloading a class is as easy as requiring the result of one access to a PHP array, fast.

<pre class="brush: php; gutter: true">&lt;?php

// autoload_classmap.php @generated by Composer

$vendorDir = dirname(dirname(__FILE__));
$baseDir = dirname($vendorDir);

return array(
    //...
    &#039;Atrapalo\\Catalog\\Domain\\Accommodation\\Rate\\Price&#039; =&gt; $baseDir . &#039;/src/Atrapalo/Catalog/Domain/Accommodation/Rate/Price.php&#039;,
    &#039;Atrapalo\\Catalog\\Domain\\Accommodation\\Rate\\Rate&#039; =&gt; $baseDir . &#039;/src/Atrapalo/Catalog/Domain/Accommodation/Rate/Rate.php&#039;,
    &#039;Atrapalo\\Catalog\\Domain\\Accommodation\\Rate\\RateServices&#039; =&gt; $baseDir . &#039;/src/Atrapalo/Catalog/Domain/Accommodation/Rate/RateServices.php&#039;,
    //...
);</pre>

Because the classmap file is a PHP file, it gets loaded into Opcache, fast again. But, if we take a closer look, there are some entries in this array related to your test classes that make the array bigger than needed for production. There are different options for removing those unnecessary entries:

  1. <a href="https://getcomposer.org/doc/04-schema.md#exclude-files-from-classmaps" target="_blank">exclude-files-from-classmaps:</a> If you want to exclude some files or folders from the classmap you can use the &#8216;exclude-from-classmap&#8217; property. This might be useful to exclude test classes in your live environment, for example, as those will be skipped from the classmap even when building an optimized autoloader.The classmap generator will ignore all files in the paths configured here. The paths are absolute from the package root directory (i.e. composer.json location), and support `*` to match anything but a slash, and `**` to match anything. `**` is implicitly added to the end of the paths.Example: <pre class="brush: javascript; gutter: true">{
    "autoload": {
        "exclude-from-classmap": ["/Tests/", "/test/", "/tests/"]
    }
}</pre>

  2. <a href="https://getcomposer.org/doc/04-schema.md#autoload-dev" target="_blank">autoload-dev</a>: This section allows to define autoload rules for development purposes.Classes needed to run the test suite should not be included in the main autoload rules to avoid polluting the autoloader in production and when other people use your package as a dependency.Therefore, it is a good idea to rely on a dedicated path for your unit tests and to add it within the autoload-dev section.Example: <pre class="brush: javascript; gutter: true">{
    "autoload": {
        "psr-4": { "MyLibrary\\": "src/" }
    },
    "autoload-dev": {
        "psr-4": { "MyLibrary\\Tests\\": "tests/" }
    }
}</pre>

With all these considerations, we have grouped all our test classes into a /tests folder, we have added PSR-4 splitting dev and no-dev.

<pre class="brush: bash; gutter: true"># ls -lah vendor/composer/autoload_classmap.php
-rw-r--r-- 1 wwwagent wwwagent 4,8M abr 11 11:01 vendor/composer/autoload_classmap.php
</pre>

<pre class="brush: bash; gutter: true"># ls -lah vendor/composer/autoload_classmap.php
-rw-r--r-- 1 wwwagent wwwagent 4,3M abr 12 16:46 vendor/composer/autoload_classmap.php
</pre>

The result is 500Kb less. For more information, take a look to <a href="http://es.slideshare.net/javier.eguiluz/new-symfony-tips-tricks-symfonycon-paris-2015" target="_blank">http://es.slideshare.net/javier.eguiluz/new-symfony-tips-tricks-symfonycon-paris-2015</a> by Javier Eguiluz.